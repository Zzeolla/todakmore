name: iOS → TestFlight

on:
  workflow_dispatch: # 수동 실행
  push:
    tags:
      - 'ios-v*' # 예: ios-v1.0.0

jobs:
  build-and-upload:
    runs-on: macos-14

    steps:
      # 1) 소스코드 가져오기
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Flutter 세팅
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          cache: true

      # 3) 의존성 복원
      - name: Flutter clean
        run: flutter clean

      - name: Flutter pub get
        run: flutter pub get

      # 4) .env 파일 생성 (Secrets -> 실제 .env)
      - name: Create .env from secret
        run: |
          rm -f .env
          cat > .env << 'EOF'
          ${{ secrets.APP_ENV_FILE }}
          EOF

      # 5) Xcode 버전 고정
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      # 6) 배포 인증서(p12) 설치
      - name: Import code signing certs
        uses: apple-actions/import-codesign-certs@v5
        with:
          p12-file-base64: ${{ secrets.APPSTORE_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.APPSTORE_CERTIFICATES_PASSWORD }}

      - name: Keychains / Identities (debug)
        run: |
          security list-keychains
          security find-identity -p codesigning -v || true
          echo "----- Apple Distribution only -----"
          security find-identity -p codesigning -v | grep -E "Apple Distribution|iPhone Distribution" || true

      - name: Debug - list profiles via App Store Connect API
        run: |
          echo "BUNDLE_ID=${{ vars.BUNDLE_ID }}"

      # 7) 프로비저닝 프로파일 자동 다운로드 (App Store용)
      - name: Download provisioning profiles
        uses: apple-actions/download-provisioning-profiles@v1
        with:
          bundle-id: ${{ vars.BUNDLE_ID }}
          profile-type: IOS_APP_STORE
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Ensure iOS project files exist
        run: |
          flutter create . --platforms=ios
          
      # ✅ Podfile에 iOS 15.0 강제 (없으면 추가, 있으면 15.0으로 교체)
      - name: Force iOS deployment target (Podfile = 15.0)
        run: |
          if [ -f ios/Podfile ]; then
            # platform 라인이 있으면 15.0으로 교체
            if grep -q "^platform :ios" ios/Podfile; then
              sed -i '' "s/^platform :ios, .*/platform :ios, '15.0'/" ios/Podfile
            else
              # 없으면 맨 위에 삽입
              sed -i '' "1s/^/platform :ios, '15.0'\n\n/" ios/Podfile
            fi
          else
            echo "ios/Podfile not found"
            exit 1
          fi

      # 9) IPA 빌드
      #    - build-number는 매번 증가해야 해서 GITHUB_RUN_NUMBER 사용
      - name: Build IPA
        run: |
          flutter build ipa \
            --release \
            --export-method app-store \
            --build-number $GITHUB_RUN_NUMBER

      # 10) 생성된 IPA 경로 찾기
      - name: Locate IPA
        id: locate_ipa
        run: |
          set -e
          ls -al build/ios/ipa || true
          IPA_PATH=$(ls -1 build/ios/ipa/*.ipa | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA found under build/ios/ipa"
            exit 1
          fi
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT

      # 11) TestFlight 업로드
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: ${{ steps.locate_ipa.outputs.ipa_path }}
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

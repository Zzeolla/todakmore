name: iOS → TestFlight

on:
  workflow_dispatch: # 수동 실행
  push:
    tags:
      - 'ios-v*' # 예: ios-v1.0.0

jobs:
  build-and-upload:
    runs-on: macos-14

    steps:
      # 1) 소스코드 가져오기
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Flutter 세팅
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          cache: true

      # 3) 의존성 복원
      - name: Flutter clean
        run: flutter clean

      - name: Flutter pub get
        run: flutter pub get

      # 4) .env 파일 생성 (Secrets -> 실제 .env)
      - name: Create .env from secret
        run: |
          rm -f .env
          cat > .env << 'EOF'
          ${{ secrets.APP_ENV_FILE }}
          EOF

      # 5) Xcode 버전 고정
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      # 6) 배포 인증서(p12) 설치
      - name: Import code signing certs
        uses: apple-actions/import-codesign-certs@v5
        with:
          p12-file-base64: ${{ secrets.APPSTORE_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.APPSTORE_CERTIFICATES_PASSWORD }}

      # 7) 프로비저닝 프로파일 자동 다운로드 (App Store용)
      - name: Download provisioning profiles
        uses: apple-actions/download-provisioning-profiles@v1
        with:
          bundle-id: ${{ vars.BUNDLE_ID }}
          profile-type: IOS_APP_STORE
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Ensure Podfile (iOS 15.0)
        run: |
          cat > ios/Podfile <<'POD'
          platform :ios, '15.0'
          ENV['COCOAPODS_DISABLE_STATS'] = 'true'
      
          use_frameworks! :linkage => :static
          use_modular_headers!
      
          require_relative 'Flutter/podhelper'
          flutter_ios_podfile_setup
      
          target 'Runner' do
            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end
      
          post_install do |installer|
            installer.pods_project.targets.each do |t|
              t.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
              end
            end
          end
          POD

      # 8) CocoaPods
      - name: Pod install (clean)
        run: |
          cd ios
          rm -rf Pods Podfile.lock .symlinks Frameworks
          pod install
          cd ..

      # 9) IPA 빌드
      #    - build-number는 매번 증가해야 해서 GITHUB_RUN_NUMBER 사용
      - name: Build IPA
        run: |
          flutter build ipa \
            --release \
            --export-options-plist=ios/exportOptions.plist \
            --build-number $GITHUB_RUN_NUMBER

      # 10) 생성된 IPA 경로 찾기
      - name: Locate IPA
        id: locate_ipa
        run: |
          set -e
          ls -al build/ios/ipa || true
          IPA_PATH=$(ls -1 build/ios/ipa/*.ipa | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA found under build/ios/ipa"
            exit 1
          fi
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT

      # 11) TestFlight 업로드
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: ${{ steps.locate_ipa.outputs.ipa_path }}
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
